(()=>{const e=new Map,t=new Map,r=new Map;let o={autosave:!0,telemetry:!0,unseenTabs:0};function n(){chrome.tabs.query({},(e=>{e.filter((e=>!(e.active||!e.id||"complete"!==e.status)&&s(e.id)))}))}function s(t){return chrome.processes.getProcessIdForTab(t,(r=>e.set(t,r))),!1}function a(o){e.delete(o),r.delete(o);const n=Array.from(t.entries())[0];if(n){const e=n[0],r=n[1];r.length>1?t.set(e,r.filter((e=>e!==o))):t.delete(e)}}async function c(e,r,n,s){if(await function(e,r,o){return new Promise(((n,s)=>{o&&!e.includes(r)?chrome.tabs.group({tabIds:r,groupId:o},(o=>{chrome.runtime.error?chrome.runtime.error.messgae.includes("No group with id")&&t.delete(o):(t.set(o,[...e,r]),n())})):chrome.tabs.group({tabIds:r},(e=>{chrome.runtime.error?s(chrome.runtime.error):(t.set(e,[r]),n())}))}))}(e,r,n),o.autosave){const e=Array.from(t.entries())[0][1];let r=[];await Promise.all(e.map((e=>{chrome.tabs.get(e,(t=>new Promise(((o,n)=>{chrome.runtime.lastError&&chrome.runtime.lastError.message.includes("No tab with id")&&(a(e),n()),r=[...r,{...({favIconUrl,title,url,id}=t),reason:s}],o()}))))}))),chrome.tabs.remove(e,(()=>{var e;e={tabs:r},chrome.runtime.sendMessage(e,(e=>{var t;chrome.runtime.lastError&&console.error("sendMessage | autosave",chrome.runtime.lastError),e?.received||(o.unseenTabs++,t=String(o.unseenTabs),chrome.action.setBadgeText({text:t}))})),function(e){const t=Object.keys(e)[0];chrome.storage.sync.get([t],(r=>{e=r[t]?[...e[t],...r[t]]:e[t],chrome.storage.sync.set({[t]:e})}))}({tabs:r})}))}}chrome.runtime.onInstalled.addListener((function(){n()})),chrome.runtime.onMessage.addListener((function(e,t,r){e?.properties&&(o={...o,...e.properties})})),chrome.processes.onUpdated.addListener((o=>{try{Array.from(e.values()).filter((e=>o[e])).map((e=>{const{cpu:t,network:r,tasks:n}=o[e];return{processId:e,cpu:t,network:r,tab:n.filter((e=>e.tabId))[0]}})).filter((e=>e.network||e.cpu>=1)).forEach((e=>{const o=r.get(e.tab.tabId);var n;o&&Object.keys(o).length&&(n=o.timestamp,Date.now()-n<1e4)||async function({tab:e,cpu:o,network:n,processId:s}){const a=Array.from(t.entries())[0];let i,m=[];const d=e.tabId;a&&a.length&&(i=a[0],m=a[1]),m.length&&m.includes(d)||await chrome.processes.getProcessInfo(s,!0,(async t=>{const a=t[s]?.privateMemory,u=Date.now();let l=r.get(d)||{tab:e,privateMemory:[],cpu:[],network:[],timestamp:u};var h,p;a>0&&(l?.privateMemory.length>=2?(h=a,(1-(p=l.privateMemory,(p.reduce(((e,t)=>e+t))/p.length).toFixed(2)/h)).toFixed(2)>=.01&&(l={...l,privateMemory:[...l?.privateMemory,a]}),l.privateMemory.length>=7&&await c(m,d,i,"memory")):l={...l,privateMemory:[...l?.privateMemory,a]}),o>=1&&(l={...l,cpu:[...l?.cpu,o]},l.cpu.length>=7&&await c(m,d,i,"cpu")),n&&(l={...l,network:[...l?.network,n]},l.network.length>=7&&await c(m,d,i,"network")),r.set(d,l={...l,timestamp:u})}))}(e)}))}catch(e){console.log(e)}})),chrome.tabs.onCreated.addListener((e=>{s(e.id)})),chrome.tabs.onRemoved.addListener((function(e,t){a(e)})),chrome.tabs.onActivated.addListener((({tabId:t})=>{e.delete(t)})),chrome.tabs.onHighlighted.addListener((()=>{n()}))})();